name: Build and Release

on:
  push:
    tags:
      - 'v*'  # v1.0.0, v1.0.1 ë“±ì˜ íƒœê·¸ push ì‹œ ìë™ ì‹¤í–‰

permissions:
  contents: write  # Required for creating releases and uploading assets

jobs:
  build-windows-installer:
    name: Build Windows Installer
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ (ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸ ìƒì„±ìš©)

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Extract version from tag
        id: get_version
        shell: bash
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Verify version consistency
        shell: bash
        run: |
          PYTHON_VERSION=$(python -c "from src.version import __version__; print(__version__)")
          TAG_VERSION="${{ steps.get_version.outputs.version }}"
          echo "Python version: $PYTHON_VERSION"
          echo "Tag version: $TAG_VERSION"
          if [ "$PYTHON_VERSION" != "$TAG_VERSION" ]; then
            echo "âŒ Error: Version mismatch!"
            echo "   src/version.py has: $PYTHON_VERSION"
            echo "   Git tag has: $TAG_VERSION"
            echo "   Please update src/version.py to match the tag version."
            exit 1
          fi
          echo "âœ… Version consistency verified: $PYTHON_VERSION"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Setup GitHub App credentials
        if: ${{ vars.GH_APP_ID != '' }}
        shell: bash
        env:
          APP_PRIVATE_KEY: ${{ secrets.GH_APP_PRIVATE_KEY }}
        run: |
          # .env íŒŒì¼ ìƒì„± (GitHub App ìë™ ì´ìŠˆ ë¦¬í¬íŒ…ìš©)
          echo "GITHUB_APP_ID=${{ vars.GH_APP_ID }}" >> .env
          echo "GITHUB_APP_INSTALLATION_ID=${{ vars.GH_APP_INSTALLATION_ID }}" >> .env
          echo "GITHUB_REPO=${{ vars.GH_ISSUE_REPO || github.repository }}" >> .env

          # Private Key íŒŒì¼ ìƒì„±
          mkdir -p secrets
          echo "$APP_PRIVATE_KEY" > secrets/github-app.pem
          echo "GITHUB_APP_PRIVATE_KEY=secrets/github-app.pem" >> .env

          echo "âœ… GitHub App credentials configured"

      - name: Build with PyInstaller
        run: |
          python -m PyInstaller tunnel-manager.spec

      - name: Verify EXE build
        run: |
          if (!(Test-Path "dist\TunnelDBManager.exe")) {
            Write-Host "âŒ Error: EXE file not found!"
            exit 1
          }
          $exeSize = (Get-Item "dist\TunnelDBManager.exe").Length / 1MB
          Write-Host "âœ… EXE built: $($exeSize.ToString('0.0')) MB"

      - name: Build Bootstrapper (for recovery feature)
        run: |
          Write-Host "Building bootstrapper for recovery/update feature..."
          python -m PyInstaller bootstrapper/bootstrapper.spec --noconfirm

          if (!(Test-Path "dist\TunnelDBManager-WebSetup.exe")) {
            Write-Host "âŒ Error: Bootstrapper build failed!"
            exit 1
          }

          $bootstrapperSize = (Get-Item "dist\TunnelDBManager-WebSetup.exe").Length / 1MB
          Write-Host "âœ… Bootstrapper built: TunnelDBManager-WebSetup.exe ($($bootstrapperSize.ToString('0.0')) MB)"
          Write-Host "   This will be included in the installer for recovery feature."

      - name: Install Inno Setup
        run: |
          choco install innosetup -y
          # Verify installation and show path
          $isccPath = Get-Command iscc -ErrorAction SilentlyContinue
          if ($isccPath) {
            Write-Host "ISCC found in PATH: $($isccPath.Source)"
          } else {
            Write-Host "Searching for ISCC.exe..."
            Get-ChildItem -Path "C:\ProgramData\chocolatey" -Recurse -Filter "ISCC.exe" -ErrorAction SilentlyContinue | ForEach-Object { Write-Host "Found: $($_.FullName)" }
          }

      - name: Build Windows Installer
        run: |
          # Add Chocolatey Inno Setup to PATH if exists
          $chocoIscc = "C:\ProgramData\chocolatey\lib\innosetup\tools"
          if (Test-Path $chocoIscc) {
            $env:PATH = "$chocoIscc;$env:PATH"
          }
          .\scripts\build-installer.ps1 -SkipPyInstaller

      - name: Verify Installer build
        id: verify_installer
        run: |
          $installerFile = Get-Item "output\TunnelDBManager-Setup-*.exe" | Select-Object -First 1
          if (!$installerFile) {
            Write-Host "âŒ Error: Installer file not found!"
            exit 1
          }
          $installerSize = $installerFile.Length / 1MB
          Write-Host "âœ… Installer built: $($installerFile.Name) ($($installerSize.ToString('0.0')) MB)"
          echo "installer_path=$($installerFile.FullName)" >> $env:GITHUB_OUTPUT
          echo "installer_name=$($installerFile.Name)" >> $env:GITHUB_OUTPUT

      - name: Generate Release Notes
        id: release_notes
        shell: bash
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"

          # ì´ì „ íƒœê·¸ ì°¾ê¸°
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          echo "Previous tag: $PREV_TAG"
          echo "Current tag: v$VERSION"

          # ë³€ê²½ì‚¬í•­ ìˆ˜ì§‘ (Conventional Commits íŒŒì‹±)
          echo "" > changes_feat.txt
          echo "" > changes_fix.txt
          echo "" > changes_docs.txt
          echo "" > changes_refactor.txt
          echo "" > changes_perf.txt
          echo "" > changes_other.txt

          if [ -n "$PREV_TAG" ]; then
            COMMITS=$(git log ${PREV_TAG}..HEAD --pretty=format:"%s" 2>/dev/null || echo "")
          else
            # ì²« ë¦´ë¦¬ìŠ¤ì¸ ê²½ìš° ìµœê·¼ 50ê°œ ì»¤ë°‹
            COMMITS=$(git log --pretty=format:"%s" -50 2>/dev/null || echo "")
          fi

          # ì»¤ë°‹ ë©”ì‹œì§€ íŒŒì‹±
          while IFS= read -r line; do
            [ -z "$line" ] && continue

            # Conventional Commits íŒŒì‹±
            if [[ "$line" =~ ^feat(\(.+\))?:\ (.+) ]]; then
              echo "- ${BASH_REMATCH[2]}" >> changes_feat.txt
            elif [[ "$line" =~ ^fix(\(.+\))?:\ (.+) ]]; then
              echo "- ${BASH_REMATCH[2]}" >> changes_fix.txt
            elif [[ "$line" =~ ^docs(\(.+\))?:\ (.+) ]]; then
              echo "- ${BASH_REMATCH[2]}" >> changes_docs.txt
            elif [[ "$line" =~ ^refactor(\(.+\))?:\ (.+) ]]; then
              echo "- ${BASH_REMATCH[2]}" >> changes_refactor.txt
            elif [[ "$line" =~ ^perf(\(.+\))?:\ (.+) ]]; then
              echo "- ${BASH_REMATCH[2]}" >> changes_perf.txt
            elif [[ ! "$line" =~ ^(chore|ci|test|style|build)(\(.+\))?:\ ]]; then
              # chore, ci, test, style, build ì œì™¸í•œ ê¸°íƒ€ ì»¤ë°‹
              if [[ ! "$line" =~ ^Merge\  ]] && [[ ! "$line" =~ ^Bump\ version ]]; then
                echo "- $line" >> changes_other.txt
              fi
            fi
          done <<< "$COMMITS"

          # ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸ ìƒì„±
          cat << 'HEADER' > release_notes.md
          ## TunnelDB Manager v$VERSION

          HEADER
          sed -i "s/\$VERSION/$VERSION/g" release_notes.md

          # ë³€ê²½ì‚¬í•­ ì„¹ì…˜ ì¶”ê°€
          HAS_CHANGES=false

          if [ -s changes_feat.txt ] && [ "$(cat changes_feat.txt | tr -d '[:space:]')" != "" ]; then
            echo "### âœ¨ ìƒˆë¡œìš´ ê¸°ëŠ¥" >> release_notes.md
            cat changes_feat.txt >> release_notes.md
            echo "" >> release_notes.md
            HAS_CHANGES=true
          fi

          if [ -s changes_fix.txt ] && [ "$(cat changes_fix.txt | tr -d '[:space:]')" != "" ]; then
            echo "### ğŸ› ë²„ê·¸ ìˆ˜ì •" >> release_notes.md
            cat changes_fix.txt >> release_notes.md
            echo "" >> release_notes.md
            HAS_CHANGES=true
          fi

          if [ -s changes_perf.txt ] && [ "$(cat changes_perf.txt | tr -d '[:space:]')" != "" ]; then
            echo "### âš¡ ì„±ëŠ¥ ê°œì„ " >> release_notes.md
            cat changes_perf.txt >> release_notes.md
            echo "" >> release_notes.md
            HAS_CHANGES=true
          fi

          if [ -s changes_refactor.txt ] && [ "$(cat changes_refactor.txt | tr -d '[:space:]')" != "" ]; then
            echo "### â™»ï¸ ë¦¬íŒ©í† ë§" >> release_notes.md
            cat changes_refactor.txt >> release_notes.md
            echo "" >> release_notes.md
            HAS_CHANGES=true
          fi

          if [ -s changes_docs.txt ] && [ "$(cat changes_docs.txt | tr -d '[:space:]')" != "" ]; then
            echo "### ğŸ“ ë¬¸ì„œ" >> release_notes.md
            cat changes_docs.txt >> release_notes.md
            echo "" >> release_notes.md
            HAS_CHANGES=true
          fi

          if [ -s changes_other.txt ] && [ "$(cat changes_other.txt | tr -d '[:space:]')" != "" ]; then
            echo "### ğŸ“¦ ê¸°íƒ€ ë³€ê²½ì‚¬í•­" >> release_notes.md
            cat changes_other.txt >> release_notes.md
            echo "" >> release_notes.md
            HAS_CHANGES=true
          fi

          if [ "$HAS_CHANGES" = false ]; then
            echo "### ğŸ“¦ ë³€ê²½ì‚¬í•­" >> release_notes.md
            echo "- ë²„ê·¸ ìˆ˜ì • ë° ì•ˆì •ì„± ê°œì„ " >> release_notes.md
            echo "" >> release_notes.md
          fi

          # ë‹¤ìš´ë¡œë“œ ë° ì„¤ì¹˜ ì•ˆë‚´
          cat << EOF >> release_notes.md
          ---

          ### ğŸ“¥ ë‹¤ìš´ë¡œë“œ
          | íŒŒì¼ | ì„¤ëª… | í¬ê¸° |
          |------|------|------|
          | \`TunnelDBManager-WebSetup.exe\` | ì˜¨ë¼ì¸ ì„¤ì¹˜ (ê¶Œì¥) | ~5MB |
          | \`TunnelDBManager-Setup-$VERSION.exe\` | ì˜¤í”„ë¼ì¸ ì„¤ì¹˜ | ~35MB |

          ### ì„¤ì¹˜ ë°©ë²•

          **ì˜¨ë¼ì¸ ì„¤ì¹˜ (ê¶Œì¥):**
          1. \`TunnelDBManager-WebSetup.exe\` ë‹¤ìš´ë¡œë“œ
          2. ì‹¤í–‰í•˜ë©´ ìë™ìœ¼ë¡œ ìµœì‹  ë²„ì „ ë‹¤ìš´ë¡œë“œ ë° ì„¤ì¹˜

          **ì˜¤í”„ë¼ì¸ ì„¤ì¹˜:**
          1. \`TunnelDBManager-Setup-$VERSION.exe\` ë‹¤ìš´ë¡œë“œ
          2. ì„¤ì¹˜ ë§ˆë²•ì‚¬ë¥¼ ë”°ë¼ ì§„í–‰
          EOF

          echo ""
          echo "========== Generated Release Notes =========="
          cat release_notes.md
          echo "============================================="

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: v${{ steps.get_version.outputs.version }}
          body_path: release_notes.md
          files: |
            output/TunnelDBManager-Setup-${{ steps.get_version.outputs.version }}.exe
            dist/TunnelDBManager-WebSetup.exe
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host " âœ… Release Created Successfully!" -ForegroundColor Green
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Release: v${{ steps.get_version.outputs.version }}" -ForegroundColor White
          Write-Host "Installer: ${{ steps.verify_installer.outputs.installer_name }}" -ForegroundColor White
          Write-Host "URL: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.get_version.outputs.version }}" -ForegroundColor White
          Write-Host ""
