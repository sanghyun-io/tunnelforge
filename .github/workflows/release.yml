name: Build and Release

on:
  push:
    tags:
      - 'v*'  # v1.0.0, v1.0.1 ë“±ì˜ íƒœê·¸ push ì‹œ ìë™ ì‹¤í–‰

jobs:
  build-windows-installer:
    name: Build Windows Installer
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Extract version from tag
        id: get_version
        shell: bash
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Verify version consistency
        shell: bash
        run: |
          PYTHON_VERSION=$(python -c "from src.version import __version__; print(__version__)")
          TAG_VERSION="${{ steps.get_version.outputs.version }}"
          echo "Python version: $PYTHON_VERSION"
          echo "Tag version: $TAG_VERSION"
          if [ "$PYTHON_VERSION" != "$TAG_VERSION" ]; then
            echo "âŒ Error: Version mismatch!"
            echo "   src/version.py has: $PYTHON_VERSION"
            echo "   Git tag has: $TAG_VERSION"
            echo "   Please update src/version.py to match the tag version."
            exit 1
          fi
          echo "âœ… Version consistency verified: $PYTHON_VERSION"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Build with PyInstaller
        run: |
          python -m PyInstaller tunnel-manager.spec

      - name: Verify EXE build
        run: |
          if (!(Test-Path "dist\TunnelDBManager.exe")) {
            Write-Host "âŒ Error: EXE file not found!"
            exit 1
          }
          $exeSize = (Get-Item "dist\TunnelDBManager.exe").Length / 1MB
          Write-Host "âœ… EXE built: $($exeSize.ToString('0.0')) MB"

      - name: Install Inno Setup
        run: |
          choco install innosetup -y
          # Verify installation and show path
          $isccPath = Get-Command iscc -ErrorAction SilentlyContinue
          if ($isccPath) {
            Write-Host "ISCC found in PATH: $($isccPath.Source)"
          } else {
            Write-Host "Searching for ISCC.exe..."
            Get-ChildItem -Path "C:\ProgramData\chocolatey" -Recurse -Filter "ISCC.exe" -ErrorAction SilentlyContinue | ForEach-Object { Write-Host "Found: $($_.FullName)" }
          }

      - name: Build Windows Installer
        run: |
          # Add Chocolatey Inno Setup to PATH if exists
          $chocoIscc = "C:\ProgramData\chocolatey\lib\innosetup\tools"
          if (Test-Path $chocoIscc) {
            $env:PATH = "$chocoIscc;$env:PATH"
          }
          .\scripts\build-installer.ps1 -SkipPyInstaller

      - name: Verify Installer build
        id: verify_installer
        run: |
          $installerFile = Get-Item "output\TunnelDBManager-Setup-*.exe" | Select-Object -First 1
          if (!$installerFile) {
            Write-Host "âŒ Error: Installer file not found!"
            exit 1
          }
          $installerSize = $installerFile.Length / 1MB
          Write-Host "âœ… Installer built: $($installerFile.Name) ($($installerSize.ToString('0.0')) MB)"
          echo "installer_path=$($installerFile.FullName)" >> $env:GITHUB_OUTPUT
          echo "installer_name=$($installerFile.Name)" >> $env:GITHUB_OUTPUT

      - name: Generate Release Notes
        id: release_notes
        shell: bash
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          cat << EOF > release_notes.md
          ## TunnelDB Manager v$VERSION

          ### ë‹¤ìš´ë¡œë“œ
          - Windows Installer: \`TunnelDBManager-Setup-$VERSION.exe\`

          ### ì„¤ì¹˜ ë°©ë²•
          1. Installerë¥¼ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤
          2. ì‹¤í–‰í•˜ì—¬ ì„¤ì¹˜ ë§ˆë²•ì‚¬ë¥¼ ë”°ë¼ê°‘ë‹ˆë‹¤
          3. ì„¤ì¹˜ ì™„ë£Œ í›„ ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤

          ### ì£¼ìš” ê¸°ëŠ¥
          - ğŸ” SSH í„°ë„ì„ í†µí•œ ì•ˆì „í•œ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°
          - ğŸš€ MySQL Shellì„ ì´ìš©í•œ ë³‘ë ¬ Export/Import
          - ğŸ”„ ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ë¶„ì„ ë„êµ¬
          - ğŸ“Š ì‹œìŠ¤í…œ íŠ¸ë ˆì´ ìƒì£¼ ê¸°ëŠ¥

          ---
          ì „ì²´ ë³€ê²½ ì‚¬í•­ì€ [CHANGELOG](https://github.com/${{ github.repository }}/compare/v$VERSION...main)ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”.
          EOF
          cat release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: v${{ steps.get_version.outputs.version }}
          body_path: release_notes.md
          files: |
            output/TunnelDBManager-Setup-*.exe
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host " âœ… Release Created Successfully!" -ForegroundColor Green
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Release: v${{ steps.get_version.outputs.version }}" -ForegroundColor White
          Write-Host "Installer: ${{ steps.verify_installer.outputs.installer_name }}" -ForegroundColor White
          Write-Host "URL: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.get_version.outputs.version }}" -ForegroundColor White
          Write-Host ""
