name: Build and Release

on:
  push:
    tags:
      - 'v*'  # v1.0.0, v1.0.1 ë“±ì˜ íƒœê·¸ push ì‹œ ìë™ ì‹¤í–‰

permissions:
  contents: write  # Required for creating releases and uploading assets

jobs:
  build-windows-installer:
    name: Build Windows Installer
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Extract version from tag
        id: get_version
        shell: bash
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Verify version consistency
        shell: bash
        run: |
          PYTHON_VERSION=$(python -c "from src.version import __version__; print(__version__)")
          TAG_VERSION="${{ steps.get_version.outputs.version }}"
          echo "Python version: $PYTHON_VERSION"
          echo "Tag version: $TAG_VERSION"
          if [ "$PYTHON_VERSION" != "$TAG_VERSION" ]; then
            echo "âŒ Error: Version mismatch!"
            echo "   src/version.py has: $PYTHON_VERSION"
            echo "   Git tag has: $TAG_VERSION"
            echo "   Please update src/version.py to match the tag version."
            exit 1
          fi
          echo "âœ… Version consistency verified: $PYTHON_VERSION"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Setup GitHub App credentials
        if: ${{ vars.GH_APP_ID != '' }}
        shell: bash
        env:
          APP_PRIVATE_KEY: ${{ secrets.GH_APP_PRIVATE_KEY }}
        run: |
          # .env íŒŒì¼ ìƒì„± (GitHub App ìë™ ì´ìŠˆ ë¦¬í¬íŒ…ìš©)
          echo "GITHUB_APP_ID=${{ vars.GH_APP_ID }}" >> .env
          echo "GITHUB_APP_INSTALLATION_ID=${{ vars.GH_APP_INSTALLATION_ID }}" >> .env
          echo "GITHUB_REPO=${{ vars.GH_ISSUE_REPO || github.repository }}" >> .env

          # Private Key íŒŒì¼ ìƒì„±
          mkdir -p secrets
          echo "$APP_PRIVATE_KEY" > secrets/github-app.pem
          echo "GITHUB_APP_PRIVATE_KEY=secrets/github-app.pem" >> .env

          echo "âœ… GitHub App credentials configured"

      - name: Build with PyInstaller
        run: |
          python -m PyInstaller tunnel-manager.spec

      - name: Verify EXE build
        run: |
          if (!(Test-Path "dist\TunnelDBManager.exe")) {
            Write-Host "âŒ Error: EXE file not found!"
            exit 1
          }
          $exeSize = (Get-Item "dist\TunnelDBManager.exe").Length / 1MB
          Write-Host "âœ… EXE built: $($exeSize.ToString('0.0')) MB"

      - name: Build Bootstrapper (for recovery feature)
        run: |
          Write-Host "Building bootstrapper for recovery/update feature..."
          python -m PyInstaller bootstrapper/bootstrapper.spec --noconfirm

          if (!(Test-Path "dist\TunnelDBManager-WebSetup.exe")) {
            Write-Host "âŒ Error: Bootstrapper build failed!"
            exit 1
          }

          $bootstrapperSize = (Get-Item "dist\TunnelDBManager-WebSetup.exe").Length / 1MB
          Write-Host "âœ… Bootstrapper built: TunnelDBManager-WebSetup.exe ($($bootstrapperSize.ToString('0.0')) MB)"
          Write-Host "   This will be included in the installer for recovery feature."

      - name: Install Inno Setup
        run: |
          choco install innosetup -y
          # Verify installation and show path
          $isccPath = Get-Command iscc -ErrorAction SilentlyContinue
          if ($isccPath) {
            Write-Host "ISCC found in PATH: $($isccPath.Source)"
          } else {
            Write-Host "Searching for ISCC.exe..."
            Get-ChildItem -Path "C:\ProgramData\chocolatey" -Recurse -Filter "ISCC.exe" -ErrorAction SilentlyContinue | ForEach-Object { Write-Host "Found: $($_.FullName)" }
          }

      - name: Build Windows Installer
        run: |
          # Add Chocolatey Inno Setup to PATH if exists
          $chocoIscc = "C:\ProgramData\chocolatey\lib\innosetup\tools"
          if (Test-Path $chocoIscc) {
            $env:PATH = "$chocoIscc;$env:PATH"
          }
          .\scripts\build-installer.ps1 -SkipPyInstaller

      - name: Verify Installer build
        id: verify_installer
        run: |
          $installerFile = Get-Item "output\TunnelDBManager-Setup-*.exe" | Select-Object -First 1
          if (!$installerFile) {
            Write-Host "âŒ Error: Installer file not found!"
            exit 1
          }
          $installerSize = $installerFile.Length / 1MB
          Write-Host "âœ… Installer built: $($installerFile.Name) ($($installerSize.ToString('0.0')) MB)"
          echo "installer_path=$($installerFile.FullName)" >> $env:GITHUB_OUTPUT
          echo "installer_name=$($installerFile.Name)" >> $env:GITHUB_OUTPUT

      - name: Generate Release Notes
        id: release_notes
        shell: bash
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          cat << EOF > release_notes.md
          ## TunnelDB Manager v$VERSION

          ### ë‹¤ìš´ë¡œë“œ
          | íŒŒì¼ | ì„¤ëª… | í¬ê¸° |
          |------|------|------|
          | \`TunnelDBManager-WebSetup.exe\` | ì˜¨ë¼ì¸ ì„¤ì¹˜ (ê¶Œì¥) | ~5MB |
          | \`TunnelDBManager-Setup-$VERSION.exe\` | ì˜¤í”„ë¼ì¸ ì„¤ì¹˜ | ~35MB |

          ### ì„¤ì¹˜ ë°©ë²•

          **ì˜¨ë¼ì¸ ì„¤ì¹˜ (ê¶Œì¥):**
          1. \`TunnelDBManager-WebSetup.exe\` ë‹¤ìš´ë¡œë“œ
          2. ì‹¤í–‰í•˜ë©´ ìë™ìœ¼ë¡œ ìµœì‹  ë²„ì „ ë‹¤ìš´ë¡œë“œ ë° ì„¤ì¹˜

          **ì˜¤í”„ë¼ì¸ ì„¤ì¹˜:**
          1. \`TunnelDBManager-Setup-$VERSION.exe\` ë‹¤ìš´ë¡œë“œ
          2. ì„¤ì¹˜ ë§ˆë²•ì‚¬ë¥¼ ë”°ë¼ ì§„í–‰

          ### ì£¼ìš” ê¸°ëŠ¥
          - ğŸ” SSH í„°ë„ì„ í†µí•œ ì•ˆì „í•œ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°
          - ğŸš€ MySQL Shellì„ ì´ìš©í•œ ë³‘ë ¬ Export/Import
          - ğŸ”„ ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ë¶„ì„ ë„êµ¬
          - ğŸ“Š ì‹œìŠ¤í…œ íŠ¸ë ˆì´ ìƒì£¼ ê¸°ëŠ¥
          - ğŸ”§ ìë™ ë³µêµ¬ ê¸°ëŠ¥ (ì˜¤ë¥˜ ë°œìƒ ì‹œ ìµœì‹  ë²„ì „ìœ¼ë¡œ ì¬ì„¤ì¹˜ ì•ˆë‚´)

          ### ë¬¸ì œ í•´ê²°
          í”„ë¡œê·¸ë¨ ì‹¤í–‰ ì˜¤ë¥˜ ë°œìƒ ì‹œ:
          - **ìë™ ì•ˆë‚´**: ì˜¤ë¥˜ ë°œìƒ ì‹œ ë³µêµ¬ í”„ë¡œê·¸ë¨ ì‹¤í–‰ ì˜µì…˜ ì œê³µ
          - **ìˆ˜ë™ ë³µêµ¬**: ì‹œì‘ ë©”ë‰´ â†’ TunnelDB Manager â†’ "ë³µêµ¬ ë° ì—…ë°ì´íŠ¸" ì‹¤í–‰

          ---
          ì „ì²´ ë³€ê²½ ì‚¬í•­ì€ [CHANGELOG](https://github.com/${{ github.repository }}/compare/v$VERSION...main)ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”.
          EOF
          cat release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: v${{ steps.get_version.outputs.version }}
          body_path: release_notes.md
          files: |
            output/TunnelDBManager-Setup-${{ steps.get_version.outputs.version }}.exe
            dist/TunnelDBManager-WebSetup.exe
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host " âœ… Release Created Successfully!" -ForegroundColor Green
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Release: v${{ steps.get_version.outputs.version }}" -ForegroundColor White
          Write-Host "Installer: ${{ steps.verify_installer.outputs.installer_name }}" -ForegroundColor White
          Write-Host "URL: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.get_version.outputs.version }}" -ForegroundColor White
          Write-Host ""
