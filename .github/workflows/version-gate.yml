name: Version Gate

# PR 라벨 기반 버전 bump — 필수 상태 체크
#
# version:* 라벨이 있으면 PR 브랜치에 bump 커밋 자동 추가.
# 브랜치 보호 규칙으로 이 체크가 통과해야만 머지 가능.

on:
  pull_request:
    types: [labeled, unlabeled, opened, synchronize, reopened]

concurrency:
  group: version-gate-${{ github.event.pull_request.number }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write

jobs:
  version-gate:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Check version labels
        id: check
        env:
          PR_LABELS: ${{ toJSON(github.event.pull_request.labels.*.name) }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # === Step 1: 라벨 검증 (최우선) ===
          VERSION_LABELS=$(echo "$PR_LABELS" | python3 -c "
          import json, sys
          labels = json.load(sys.stdin)
          version_labels = [l for l in labels if l.startswith('version:')]
          for l in version_labels:
              print(l)
          ")

          COUNT=$(echo "$VERSION_LABELS" | grep -c 'version:' || true)
          echo "감지된 version 라벨 수: $COUNT"

          if [ "$COUNT" -gt 1 ]; then
            echo "ERROR: 복수의 version 라벨 감지: $VERSION_LABELS"
            gh pr comment "$PR_NUMBER" --body \
              "⚠️ **Auto-version 실패**: 복수의 version 라벨이 감지되었습니다.

          감지된 라벨: \`$(echo $VERSION_LABELS | tr '\n' ' ')\`

          정확히 **1개**의 version 라벨만 허용됩니다:
          - \`version:patch\` — 버그 수정 (X.Y.Z+1)
          - \`version:minor\` — 새 기능 (X.Y+1.0)
          - \`version:major\` — Breaking changes (X+1.0.0)"
            exit 1
          fi

          if [ "$COUNT" -eq 0 ]; then
            echo "version 라벨 없음. 버전 bump 불필요 — 통과."
            echo "bump_type=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          BUMP_TYPE=$(echo "$VERSION_LABELS" | head -1 | sed 's/version://')
          echo "감지된 bump_type: $BUMP_TYPE"

          # === Step 2: 기존 bump 커밋 확인 (라벨 정합성 포함) ===
          # bump 커밋 메시지에 [patch]/[minor]/[major] 트레일러로 타입 검증.
          # 트레일러 없는 레거시 bump 커밋도 호환 처리.

          # HEAD 체크 (synchronize 재귀 방지)
          HEAD_MSG=$(gh api "repos/${{ github.repository }}/commits/${HEAD_SHA}" \
            --jq .commit.message 2>/dev/null || true)
          if echo "$HEAD_MSG" | grep -q "^chore: bump version"; then
            if echo "$HEAD_MSG" | grep -q "\[$BUMP_TYPE\]" || \
               ! echo "$HEAD_MSG" | grep -qE "\[(patch|minor|major)\]"; then
              echo "HEAD가 bump 커밋 (타입 일치 또는 레거시). 체크 통과."
              echo "bump_type=" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            echo "HEAD가 다른 타입의 bump 커밋. 재bump 필요."
            echo "needs_rebump=true" >> "$GITHUB_OUTPUT"
          fi

          # PR 커밋 히스토리 체크 (페이지네이션 적용)
          BUMP_MSGS=$(gh api --paginate \
            "repos/${{ github.repository }}/pulls/${PR_NUMBER}/commits" \
            --jq '.[].commit.message' | grep "^chore: bump version" || true)
          if [ -n "$BUMP_MSGS" ]; then
            if echo "$BUMP_MSGS" | grep -q "\[$BUMP_TYPE\]" || \
               ! echo "$BUMP_MSGS" | grep -qE "\[(patch|minor|major)\]"; then
              echo "PR에 이미 bump 커밋 존재 (타입 일치 또는 레거시). 체크 통과."
              echo "bump_type=" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            echo "기존 bump 커밋이 현재 라벨과 불일치. 재bump 필요."
            echo "needs_rebump=true" >> "$GITHUB_OUTPUT"
          fi

          echo "bump_type=$BUMP_TYPE" >> "$GITHUB_OUTPUT"

      - name: Generate GitHub App Token
        if: steps.check.outputs.bump_type != ''
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.RELEASER_APP_ID }}
          private-key: ${{ secrets.RELEASER_APP_PRIVATE_KEY }}

      - name: Checkout PR branch
        if: steps.check.outputs.bump_type != ''
        uses: actions/checkout@v4
        with:
          token: ${{ steps.app-token.outputs.token }}
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Set up Python
        if: steps.check.outputs.bump_type != ''
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Check if already bumped & bump version (idempotent)
        if: steps.check.outputs.bump_type != ''
        id: bump
        env:
          BUMP_TYPE: ${{ steps.check.outputs.bump_type }}
          NEEDS_REBUMP: ${{ steps.check.outputs.needs_rebump }}
          BASE_REF: ${{ github.event.pull_request.base.ref }}
        run: |
          set -euo pipefail

          # base 브랜치 버전 조회 (동적 — hardcoded origin/main 제거)
          BASE_VERSION=$(git show "origin/${BASE_REF}:src/version.py" | grep '__version__' | cut -d'"' -f2)
          CURRENT=$(grep '__version__' src/version.py | cut -d'"' -f2)
          echo "base 버전(${BASE_REF}): $BASE_VERSION / 현재 버전: $CURRENT"

          # 빈 값 검증 (파싱 실패 시 즉시 실패)
          if [ -z "$BASE_VERSION" ] || [ -z "$CURRENT" ]; then
            echo "ERROR: 버전 파싱 실패 (base='$BASE_VERSION', current='$CURRENT')"
            exit 1
          fi

          if [ "$BASE_VERSION" != "$CURRENT" ] && [ "$NEEDS_REBUMP" != "true" ]; then
            echo "버전이 이미 변경됨 ($BASE_VERSION → $CURRENT). 건너뜁니다."
            echo "skip=true" >> "$GITHUB_OUTPUT"
          else
            if [ "$NEEDS_REBUMP" = "true" ]; then
              echo "라벨 변경으로 인한 재bump. base 버전으로 복원 후 재bump."
              git checkout "origin/${BASE_REF}" -- src/version.py pyproject.toml
            fi
            python scripts/bump_version.py --bump-type "$BUMP_TYPE" --dry-run > /tmp/bump_dry.txt
            EXPECTED=$(grep 'new_version=' /tmp/bump_dry.txt | cut -d= -f2)
            echo "예상 bump 버전: $EXPECTED"
            echo "skip=false" >> "$GITHUB_OUTPUT"
            echo "new_version=$EXPECTED" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit and push bump to PR branch
        if: steps.check.outputs.bump_type != '' && steps.bump.outputs.skip != 'true'
        env:
          NEW_VERSION: ${{ steps.bump.outputs.new_version }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          python scripts/bump_version.py --bump-type "${{ steps.check.outputs.bump_type }}"
          git add src/version.py pyproject.toml
          git commit -m "chore: bump version to v${NEW_VERSION} [${{ steps.check.outputs.bump_type }}]"
          git push origin "${{ github.event.pull_request.head.ref }}"
          echo "버전 bump 완료: v${NEW_VERSION}"
