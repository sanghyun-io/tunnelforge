name: Auto Version

# PR ë¼ë²¨ ê¸°ë°˜ ìë™ ë²„ì €ë‹
#
# Job 1 (create-release-pr):
#   Feature PRì— version:* ë¼ë²¨ â†’ ë¨¸ì§€ ì‹œ â†’ Release PR ìë™ ìƒì„±
#
# Job 2 (create-release-tag):
#   Release PR ë¨¸ì§€ ì‹œ â†’ íƒœê·¸ ìƒì„± â†’ release.yml íŠ¸ë¦¬ê±°

on:
  pull_request:
    types: [closed]

# ë™ì‹œ ì‹¤í–‰ ë°©ì§€: ë²„ì €ë‹ ì‘ì—…ì€ ì§ë ¬ë¡œ ì²˜ë¦¬
concurrency:
  group: auto-version
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 1: Feature PR ë¨¸ì§€ â†’ Release PR ìƒì„±
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  create-release-pr:
    # Feature PRì´ ë¨¸ì§€ëê³ , version:* ë¼ë²¨ ì¤‘ í•˜ë‚˜ê°€ ìˆì„ ë•Œ
    if: >
      github.event.pull_request.merged == true &&
      contains(toJSON(github.event.pull_request.labels.*.name), 'version:')
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Detect version label
        id: detect
        env:
          PR_LABELS: ${{ toJSON(github.event.pull_request.labels.*.name) }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # version:* ë¼ë²¨ ì¶”ì¶œ
          VERSION_LABELS=$(echo "$PR_LABELS" | python3 -c "
          import json, sys
          labels = json.load(sys.stdin)
          version_labels = [l for l in labels if l.startswith('version:')]
          for l in version_labels:
              print(l)
          ")

          COUNT=$(echo "$VERSION_LABELS" | grep -c 'version:' || true)
          echo "ê°ì§€ëœ version ë¼ë²¨ ìˆ˜: $COUNT"
          echo "$VERSION_LABELS"

          if [ "$COUNT" -gt 1 ]; then
            echo "ERROR: ë³µìˆ˜ì˜ version ë¼ë²¨ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤: $VERSION_LABELS"
            # PR ì½”ë©˜íŠ¸ë¡œ ì—ëŸ¬ ì•Œë¦¼
            gh pr comment "$PR_NUMBER" --body \
              "âš ï¸ **Auto-version ì‹¤íŒ¨**: ë³µìˆ˜ì˜ version ë¼ë²¨ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.

          ê°ì§€ëœ ë¼ë²¨: \`$(echo $VERSION_LABELS | tr '\n' ' ')\`

          ì •í™•íˆ **1ê°œ**ì˜ version ë¼ë²¨ë§Œ í—ˆìš©ë©ë‹ˆë‹¤:
          - \`version:patch\` â€” ë²„ê·¸ ìˆ˜ì • (X.Y.Z+1)
          - \`version:minor\` â€” ìƒˆ ê¸°ëŠ¥ (X.Y+1.0)
          - \`version:major\` â€” Breaking changes (X+1.0.0)

          ë¼ë²¨ì„ ìˆ˜ì • í›„ ë‹¤ìŒ PRì—ì„œ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”."
            exit 1
          fi

          if [ "$COUNT" -eq 0 ]; then
            echo "version ë¼ë²¨ ì—†ìŒ. ê±´ë„ˆëœë‹ˆë‹¤."
            echo "bump_type=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # bump_type ì¶”ì¶œ (version:patch â†’ patch)
          BUMP_TYPE=$(echo "$VERSION_LABELS" | head -1 | sed 's/version://')
          echo "bump_type=$BUMP_TYPE" >> "$GITHUB_OUTPUT"
          echo "ê°ì§€ëœ bump_type: $BUMP_TYPE"

      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.RELEASER_APP_ID }}
          private-key: ${{ secrets.RELEASER_APP_PRIVATE_KEY }}

      - name: Checkout main
        uses: actions/checkout@v4
        with:
          token: ${{ steps.app-token.outputs.token }}
          ref: main
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Bump version (dry-run to get new version)
        id: bump-preview
        run: |
          python scripts/bump_version.py \
            --bump-type ${{ steps.detect.outputs.bump_type }} \
            --dry-run >> "$GITHUB_OUTPUT"

      - name: Check idempotency (branch)
        id: idempotency
        env:
          NEW_VERSION: ${{ steps.bump-preview.outputs.new_version }}
        run: |
          BRANCH="release/v${NEW_VERSION}"
          if git ls-remote --heads origin "$BRANCH" | grep -q "$BRANCH"; then
            echo "ë¸Œëœì¹˜ $BRANCH ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤. ê±´ë„ˆëœë‹ˆë‹¤."
            echo "skip=true" >> "$GITHUB_OUTPUT"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Bump version (actual)
        if: steps.idempotency.outputs.skip != 'true'
        id: bump
        run: |
          python scripts/bump_version.py \
            --bump-type ${{ steps.detect.outputs.bump_type }} >> "$GITHUB_OUTPUT"

      - name: Create release branch and PR
        if: steps.idempotency.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          NEW_VERSION: ${{ steps.bump.outputs.new_version }}
          BUMP_TYPE: ${{ steps.detect.outputs.bump_type }}
          SOURCE_PR_NUMBER: ${{ github.event.pull_request.number }}
          SOURCE_PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          BRANCH="release/v${NEW_VERSION}"
          git checkout -b "$BRANCH"
          git add src/version.py pyproject.toml
          git commit -m "chore: release v${NEW_VERSION}"
          git push origin "$BRANCH"

          gh pr create \
            --title "chore: release v${NEW_VERSION}" \
            --body "## Release v${NEW_VERSION}

          ìë™ ìƒì„±ëœ ë¦´ë¦¬ìŠ¤ PRì…ë‹ˆë‹¤.

          | í•­ëª© | ê°’ |
          |------|-----|
          | ë²„ì „ bump | \`${BUMP_TYPE}\` |
          | ì†ŒìŠ¤ PR | #${SOURCE_PR_NUMBER} (${SOURCE_PR_TITLE}) |
          | ìƒˆ ë²„ì „ | \`v${NEW_VERSION}\` |

          ì´ PRì´ ë¨¸ì§€ë˜ë©´ íƒœê·¸ \`v${NEW_VERSION}\`ì´ ìë™ ìƒì„±ë˜ê³  ë¦´ë¦¬ìŠ¤ ë¹Œë“œê°€ ì‹œì‘ë©ë‹ˆë‹¤.

          ğŸ¤– Generated by [auto-version.yml](.github/workflows/auto-version.yml)" \
            --base main \
            --head "$BRANCH"


  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 2: Release PR ë¨¸ì§€ â†’ íƒœê·¸ ìƒì„±
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  create-release-tag:
    # Release PR (ì œëª©: "chore: release vX.Y.Z")ì´ ë¨¸ì§€ëì„ ë•Œ
    if: >
      github.event.pull_request.merged == true &&
      startsWith(github.event.pull_request.title, 'chore: release v')
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Extract version from PR title
        id: extract
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          # "chore: release v1.11.1" â†’ "1.11.1"
          VERSION=$(echo "$PR_TITLE" | sed 's/chore: release v//')
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "ì¶”ì¶œëœ ë²„ì „: $VERSION"

      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.RELEASER_APP_ID }}
          private-key: ${{ secrets.RELEASER_APP_PRIVATE_KEY }}

      - name: Checkout main
        uses: actions/checkout@v4
        with:
          token: ${{ steps.app-token.outputs.token }}
          ref: main
          fetch-depth: 0

      - name: Check idempotency (tag)
        id: idempotency
        env:
          VERSION: ${{ steps.extract.outputs.version }}
        run: |
          TAG="v${VERSION}"
          if git ls-remote --tags origin "$TAG" | grep -q "$TAG"; then
            echo "íƒœê·¸ $TAG ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤. ê±´ë„ˆëœë‹ˆë‹¤."
            echo "skip=true" >> "$GITHUB_OUTPUT"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create and push tag
        if: steps.idempotency.outputs.skip != 'true'
        env:
          VERSION: ${{ steps.extract.outputs.version }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          TAG="v${VERSION}"
          git tag -a "$TAG" -m "Release ${TAG}"
          git push origin "$TAG"
          echo "íƒœê·¸ ${TAG} ìƒì„± ë° push ì™„ë£Œ â†’ release.yml íŠ¸ë¦¬ê±°ë¨"
