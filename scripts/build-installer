#!/usr/bin/env bash
# TunnelDB Manager - Build Installer (Bash Wrapper)

# Check for help flag
if [[ "$1" == "-h" || "$1" == "-Help" || "$1" == "--help" ]]; then
    cat << 'EOF'

TunnelDB Manager - Build Installer

Build Windows Installer locally.

Usage:
  ./scripts/build-installer [-Clean] [-SkipPyInstaller]

Options:
  -Clean           Delete previous build directories before building
  -SkipPyInstaller Skip PyInstaller build, only create installer
  -h, -Help        Show this help

Build Process:
  1. Read version from src/version.py
  2. Build EXE with PyInstaller
  3. Create Windows Installer with Inno Setup

Output:
  - dist\TunnelDBManager.exe                    (executable)
  - output\TunnelDBManager-Setup-{version}.exe  (installer)

Examples:
  # Basic build
  ./scripts/build-installer

  # Clean build
  ./scripts/build-installer -Clean

  # Rebuild installer only
  ./scripts/build-installer -SkipPyInstaller

Requirements:
  - Python 3.9+
  - PyInstaller (pip install -e ".[dev]")
  - Inno Setup 6 (https://jrsoftware.org/isinfo.php)

EOF
    exit 0
fi

# Convert path to Windows format
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd -W 2>/dev/null || pwd)"
PS_SCRIPT="$SCRIPT_DIR\\build-installer.ps1"
PS_SCRIPT="${PS_SCRIPT//\//\\}"

# Call PowerShell script
powershell.exe -NoProfile -ExecutionPolicy Bypass -Command "
    [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
    & '$PS_SCRIPT' $*
"
